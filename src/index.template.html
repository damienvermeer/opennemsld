<!DOCTYPE html>
<html>
<head>
    <title>üá¶üá∫‚ö°Ô∏èNEM SLD | v%%VERSION%%</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.css" />
    <script src="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.js"></script>
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            background-color: #f2f2f2;
            font-family: 'Roboto', sans-serif;
        }
    
    .location-popup .leaflet-popup-content-wrapper,
    .object-popup .leaflet-popup-content-wrapper {
        background: rgba(255, 255, 255, 1);
        border-radius: 4px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    }
    
    .location-popup .leaflet-popup-content,
    .object-popup .leaflet-popup-content {
        margin: 5px 10px;
        font-size: 12px;
        font-weight: bold;
        color: #333;
        text-align: center;
    }
    
    .location-popup .leaflet-popup-tip,
    .object-popup .leaflet-popup-tip {
        background: rgba(255, 255, 255, 0.1);
    }

    /* Align search control with zoom control */
    .leaflet-top.leaflet-right {
        display: grid;
        grid-template-areas: "search zoom"
                             ".      zoomfit";
        grid-template-columns: auto auto;
        grid-gap: 10px;
    }
    .leaflet-top.leaflet-left {
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }
    .leaflet-control-search { grid-area: search; align-self: start; }
    .leaflet-control-zoom { grid-area: zoom; }
    .zoom-to-fit-control { grid-area: zoomfit; }
    .title-control {
        background: rgba(255, 255, 255, 1);
        padding: 5px 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        text-align: center;
        width: 173px;
        box-sizing: border-box;
    }
    .title-control b {
        font-size: 1.2em;
    }
    .title-control a {
        text-decoration: none;
        font-size: 1.2em;
        vertical-align: middle;
    }
    .help-buttons {
        width: 150px;
    }
    .help-buttons a {
        font-size: 14px;
        padding: 3px 8px;
        display: block;
        text-align: center;
    }
    .help-buttons a:first-child {
        border-bottom: 1px solid #ddd;
        border-radius: 4px 4px 0 0;
    }
    .help-buttons a:last-child {
        border-radius: 0 0 4px 4px;
    }
    /* Modal styles */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 10000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
    }
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto; /* 15% from the top and centered */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Could be more or less, depending on screen size */
        max-width: 600px;
        border-radius: 8px;
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
        position: relative;
    }
    .modal-content h2 {
        text-align: center;
        margin-top: 0;
    }
    .modal-content ul {
        list-style-type: disc;
        padding-left: 20px;
    }
    .modal-content li {
        margin-bottom: 10px;
    }
    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    /* Ensure all controls use Roboto font */
    .leaflet-control-zoom a,
    .zoom-to-fit-control a,
    .help-buttons a,
    .leaflet-control-search .search-input,
    .leaflet-control-search .search-tooltip {
        font-family: 'Roboto', sans-serif;
    }

    @media (max-width: 768px) {
        .title-control {
            width: 86px;
            padding: 3px 5px;
            font-size: 10px;
        }
        .help-buttons {
            width: 75px;
        }
        .help-buttons a {
            font-size: 8px;
            padding: 1px 4px;
        }
    }
    </style>
</head>
<body>

<div id="map"></div>

<div id="helpModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeHelpModal()">&times;</span>
        <h2>Welcome to NEM SLD! üéâ</h2>
        <ul>
            <li>This is a geographic schematic of the Australian electrical system (transmission and sub-transmission).</li>
            <li>The substations are approximately located at their real-world locations (relative to each other) - but lines are not necessarily in the correct location relative to each substation.</li>
            <li>The layout of switchgear is based on the real-world layout of the substations - but spare bays or the exact location of bays has sometimes been simplified for the diagram.</li>
            <li>You can click to pan around, scroll in and out or use the search bar (Ctrl+F) to find substations by name.</li>
            <li>Some generators and assets have additional information available if you hover on them.</li>
        </ul>
        
        <h3>NEM SLD? All I see is Victoria!?</h3>
        <p><b style="color: red;">This is a work in progress! I've so far only implemented parts of Victoria, with much more to come...</b></p>
        
        <h3>Where's the data from?</h3>
        <p>AEMO used to publish the <a href="https://web.archive.org/web/20220119012004if_/https://aemo.com.au/-/media/files/electricity/nem/planning_and_forecasting/maps/nem-slds.pdf#[{%22num%22%3A91%2C%22gen%22%3A0}%2C{%22name%22%3A%22FitR%22}%2C-7%2C0%2C849%2C1181]" target="_blank">NEM SLDs</a> but these haven't been updated since 2019. <a href="https://openinframap.org/#6.89/-36.804/144.698" target="_blank">Open Infrastructure Map</a> has been used for some geographic data.</p>
        
        <h3>Is this free?</h3>
        <p>Yep, everything is <a href="https://github.com/damienvermeer/opennemsld" target="_blank">available on GitHub here</a>.</p>
        </ul>
    </div>
</div>

<div id="errorModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeErrorModal()">&times;</span>
        <h2>Notice an error? ü§î</h2>
        <p>Note - I am still working on migrating the existing AEMO .pdf NEM SLDs into this interactive format!</p>
        <p>This diagram is community-sourced - please let me know if you have any updates or corrections! You can help by <a href="mailto:updates@nemsld.com">emailing updates@nemsld.com</a> (or <a href="https://github.com/damienvermeer/opennemsld" target="_blank">post an issue on GitHub</a>) with:</p>
        <ul>
            <li>Details of any errors, corrections or changes - providing references for these would be helpful to cross-check.</li>
            <li>Any public information about the layout of switchgear at substations, or new substations (including their location and layout) or new generating systems (once built - not just commited stage).</li>
            <li>For those who want to get into the details, the codebase and data structure which describes each substation is <a href="https://github.com/damienvermeer/opennemsld" target="_blank">available on GitHub here</a> (and the <a href="https://github.com/damienvermeer/opennemsld/blob/main/docs/language-reference.md" target="_blank">substation language reference</a> has some more information about how to contribute).</li>
        </ul>
    </div>
</div>

<script>
    function showHelp() {
        document.getElementById('helpModal').style.display = 'block';
    }

    function closeHelpModal() {
        document.getElementById('helpModal').style.display = 'none';
    }

    function reportError() {
        document.getElementById('errorModal').style.display = 'block';
    }

    function closeErrorModal() {
        document.getElementById('errorModal').style.display = 'none';
    }

    // Close modals if user clicks outside of the modal content
    window.onclick = function(event) {
        var helpModal = document.getElementById('helpModal');
        var errorModal = document.getElementById('errorModal');
        if (event.target == helpModal) {
            closeHelpModal();
        }
        if (event.target == errorModal) {
            closeErrorModal();
        }
    }

    // Initialize the map
    var map = L.map('map', {
        crs: L.CRS.Simple,
        minZoom: -5, // Allow zooming out
        maxZoom: 2,  // Allow zooming in
        zoomDelta: 0.02, // Smaller zoom steps
        zoomSnap: 0, // Snap to smaller increments
        zoomControl: false
    });

    // Add zoom control to the top right
    L.control.zoom({ position: 'topright' }).addTo(map);

    // --- Title Control ---
    var TitleControl = L.Control.extend({
        options: {
            position: 'topleft'
        },
        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-control title-control');
            container.innerHTML = '<b>üá¶üá∫‚ö°Ô∏èNEM SLD</b><hr style="margin: 4px 0; border: 0; border-top: 1px solid #ccc;">Version %%VERSION%% <a href="https://github.com/damienvermeer/opennemsld/releases" target="_blank" title="Changelog">&#x1F517;</a>';
            L.DomEvent.disableClickPropagation(container);
            return container;
        }
    });
    map.addControl(new TitleControl());

    // --- Help/Error Buttons ---
    var HelpControl = L.Control.extend({
        options: {
            position: 'topleft'
        },
        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control help-buttons');
            
            // Help button
            var helpButton = L.DomUtil.create('a', '', container);
            helpButton.innerHTML = 'What is this?';
            helpButton.href = '#';
            helpButton.title = 'Help';
            helpButton.role = 'button';
            helpButton.style.width = '89%';
            helpButton.style.textAlign = 'center';
            L.DomEvent.on(helpButton, 'click', L.DomEvent.stop);
            L.DomEvent.on(helpButton, 'click', function () {
                showHelp();
            });
            L.DomEvent.on(helpButton, 'click', L.DomEvent.preventDefault);

            // Error button
            var errorButton = L.DomUtil.create('a', '', container);
            errorButton.innerHTML = 'Notice an error?';
            errorButton.href = '#';
            errorButton.title = 'Report an error';
            errorButton.role = 'button';
            errorButton.style.width = '89%';
            errorButton.style.textAlign = 'center';
            L.DomEvent.on(errorButton, 'click', L.DomEvent.stop);
            L.DomEvent.on(errorButton, 'click', function () {
                reportError();
            });
            L.DomEvent.on(errorButton, 'click', L.DomEvent.preventDefault);

            return container;
        }
    });
    map.addControl(new HelpControl());

    // Define the bounds to match the SVG dimensions (5000x5000)
    var bounds = [[0, 0], [16000, 16000]];
    
    // Create SVG element - This is where you would paste your pre-prepared SVG content
    var svgString = `%%SVG_CONTENT%%`;

    // Parse the SVG string into an SVG DOM element
    var parser = new DOMParser();
    var svgDoc = parser.parseFromString(svgString, 'image/svg+xml');
    var svgElement = svgDoc.documentElement;

    // Inject Roboto font style into SVG
    var style = document.createElementNS('http://www.w3.org/2000/svg', 'style');
    style.textContent = "@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap'); text { font-family: 'Roboto', sans-serif !important; }";
    svgElement.prepend(style);
    
    // Create a proper SVG overlay with the SVG element
    var overlay = L.svgOverlay(svgElement, bounds).addTo(map);
    
    // Fit the map to the bounds
    map.fitBounds(bounds);
    
    // --- Object popups for generators ---
    // This will be filled by the Python script
    var objectPopups = %%OBJECT_POPUPS%%;

    // --- Search functionality ---

    // Data for searchable locations (substations)
    var locations = %%LOCATIONS_DATA%%;

    // Add popups for generator objects if available
    if (objectPopups && objectPopups.length > 0) {
        objectPopups.forEach(function(obj) {
            // Invert Y coordinate
            var objY = obj.coords[0]; // Invert y-axis
            var objX = obj.coords[1];
            var objLatLng = [objY, objX]; 
            
            // Use a marker with constant physical size regardless of zoom
            var objMarker = L.marker(objLatLng, {
                icon: L.divIcon({
                    className: 'generator-marker',
                    html: '<div style="background-color: rgba(68, 204, 68, 0.2); border: 1px solid rgba(68, 204, 68, 0.8); border-radius: 50%; width: 20px; height: 20px;"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                }),
                interactive: true,
                opacity: 0.1
            });
            
            objMarker.bindPopup(obj.info, {
                closeButton: false,
                offset: L.point(0, -3),
                className: 'object-popup'
            });
            
            objMarker.on('mouseover', function(e) {
                this.openPopup();
            });
            
            objMarker.on('mouseout', function(e) {
                this.closePopup();
            });
            
            objMarker.addTo(map);
        });
    }

    // Convert locations to GeoJSON features for the search plugin
    var features = locations.map(function(loc) {
        return {
            type: "Feature",
            properties: {
                title: loc.title
            },
            geometry: {
                type: "Point",
                // GeoJSON is [x, y], our coords are [y, x] for Leaflet.
                coordinates: [loc.coords[1], loc.coords[0]]
            }
        };
    });

    // Create a GeoJSON layer for searching, but don't add it to the map and make it invisible
    var featuresLayer = L.geoJSON(features, {
        pointToLayer: function(feature, latlng) {
            // Create an invisible marker
            return L.marker(latlng, {
                opacity: 0,  // Make marker completely transparent
                interactive: true  // Keep it interactive for search functionality
            });
        }
    });

    // --- Zoom to fit control ---
    var ZoomToFitControl = L.Control.extend({
        options: {
            position: 'topright'
        },
        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control zoom-to-fit-control');
            var button = L.DomUtil.create('a', '', container);
            button.innerHTML = '&#x26F6;'; // SQUARE WITH FOUR CORNERS
            button.href = '#';
            button.title = 'Zoom to fit';
            button.role = 'button';
            button.setAttribute('aria-label', 'Zoom to fit');
            button.style.fontSize = '1.5em';

            L.DomEvent.on(button, 'click', L.DomEvent.stop);
            L.DomEvent.on(button, 'click', function () {
                map.fitBounds(bounds);
            });
            L.DomEvent.on(button, 'click', L.DomEvent.preventDefault);

            return container;
        }
    });
    map.addControl(new ZoomToFitControl());

    // Initialize the search control
    var searchControl = new L.Control.Search({
        layer: featuresLayer,
        propertyName: 'title',
        initial: false,
        marker: false, // Do not show a marker on the map
        markerLocation: false, // Do not show the circle when location found
        moveToLocation: function(latlng, title, map) {
            map.flyTo(latlng, 0, {
                duration: 1
            });
        },
        textPlaceholder: 'e.g. ARTS',
        textErr: 'Location not found',
        title: 'Search Substations',
        zoom: 4,
        position: 'topright'
    });
    map.addControl(searchControl);

    // Override Enter key to select the first result
    var searchInput = document.querySelector('.search-input');
    if (searchInput) {
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                var firstResult = document.querySelector('.search-tooltip a');
                if (firstResult) {
                    firstResult.click();
                }
            }
        });
    }

    // Override Ctrl+F to focus the search box
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && (e.key === 'f' || e.key === 'F')) {
            e.preventDefault();
            var searchContainer = document.querySelector('.leaflet-control-search');
            if (searchContainer && !searchContainer.classList.contains('search-exp')) {
                // If collapsed, click the button to expand and focus
                var searchButton = searchContainer.querySelector('.search-button');
                if (searchButton) {
                    searchButton.click();
                }
            } else {
                // If already expanded, just focus the input
                var searchInput = document.querySelector('.search-input');
                if (searchInput) {
                    searchInput.focus();
                }
            }
        }
    });

    // Show help on page load
    showHelp();
</script>

</body>
</html>
